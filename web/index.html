<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="A new Flutter project.">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="mediapipe_channeling_test">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>mediapipe_channeling_test</title>
  <link rel="manifest" href="manifest.json">
  
  <!-- MediaPipe Web SDK - 직접 호스팅 -->
  <script type="module">
    // 모던 브라우저용 ES6 모듈 방식
    window.MediaPipeLoaded = false;
    window.MediaPipeError = null;
    
    try {
      console.log('🔄 Loading MediaPipe SDK (ES6 Module)...');
      
      // ES6 모듈 동적 import
      const { FilesetResolver, HandLandmarker, GestureRecognizer } = await import('https://cdn.skypack.dev/@mediapipe/tasks-vision@0.10.14');
      
      // 전역으로 노출
      window.MediaPipeTasksVision = {
        FilesetResolver,
        HandLandmarker, 
        GestureRecognizer
      };
      
      window.MediaPipeLoaded = true;
      console.log('✅ MediaPipe SDK loaded successfully (ES6)');
      
    } catch (error) {
      console.warn('⚠️ ES6 import failed, trying UMD fallback:', error);
      loadUMDFallback();
    }
    
    function loadUMDFallback() {
      console.log('🔄 Loading MediaPipe SDK (UMD fallback)...');
      
      // UMD 방식 fallback
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/@mediapipe/tasks-vision@0.10.14/vision_bundle.js';
      script.type = 'text/javascript';
      
      script.onload = function() {
        console.log('📦 UMD script loaded, checking for MediaPipe...');
        
        setTimeout(() => {
          if (typeof MediaPipeTasksVision !== 'undefined') {
            window.MediaPipeTasksVision = MediaPipeTasksVision;
            window.MediaPipeLoaded = true;
            console.log('✅ MediaPipe SDK loaded successfully (UMD)');
          } else {
            console.warn('❌ MediaPipe not found, using mock implementation');
            loadMockImplementation();
          }
        }, 1000);
      };
      
      script.onerror = function() {
        console.warn('❌ UMD loading failed, using mock implementation');
        loadMockImplementation();
      };
      
      document.head.appendChild(script);
    }
    
    function loadMockImplementation() {
      console.log('🔄 Loading MediaPipe mock implementation...');
      
      // Mock implementation that actually works
      window.MediaPipeTasksVision = {
        FilesetResolver: {
          forVisionTasks: function(wasmUrl) {
            console.log('🔧 Mock FilesetResolver initialized');
            return Promise.resolve({
              mockFileset: true,
              wasmUrl: wasmUrl
            });
          }
        },
        HandLandmarker: {
          createFromOptions: function(fileset, options) {
            console.log('🔧 Mock HandLandmarker created');
            return Promise.resolve({
              detectForVideo: function(canvas, timestamp) {
                // 실제 랜드마크와 유사한 구조로 mock 데이터 생성
                const landmarks = [];
                for (let i = 0; i < 21; i++) {
                  landmarks.push({
                    x: 0.4 + (i % 5) * 0.04,
                    y: 0.3 + Math.floor(i / 5) * 0.08,
                    z: 0.0
                  });
                }
                
                return {
                  landmarks: [landmarks],
                  handedness: [[{
                    categoryName: 'Right',
                    score: 0.9
                  }]]
                };
              },
              close: function() {
                console.log('🧹 Mock HandLandmarker closed');
              }
            });
          }
        },
        GestureRecognizer: {
          createFromOptions: function(fileset, options) {
            console.log('🔧 Mock GestureRecognizer created');
            return Promise.resolve({
              recognize: function(canvas, timestamp) {
                const landmarks = [];
                for (let i = 0; i < 21; i++) {
                  landmarks.push({
                    x: 0.4 + (i % 5) * 0.04,
                    y: 0.3 + Math.floor(i / 5) * 0.08,
                    z: 0.0
                  });
                }
                
                return {
                  gestures: [[{
                    categoryName: 'Open_Palm',
                    score: 0.85
                  }]],
                  landmarks: [landmarks],
                  handedness: [[{
                    categoryName: 'Right',
                    score: 0.9
                  }]],
                  worldLandmarks: [landmarks]
                };
              },
              close: function() {
                console.log('🧹 Mock GestureRecognizer closed');
              }
            });
          }
        }
      };
      
      window.MediaPipeLoaded = true;
      console.log('✅ MediaPipe mock implementation ready');
    }
  </script>
  
  <!-- 레거시 브라우저 fallback -->
  <script nomodule>
    console.log('🔄 Legacy browser detected, loading UMD version...');
    loadUMDFallback();
  </script>
</head>
<body>
  <script>
    // MediaPipe 로딩 상태 확인
    function checkMediaPipeLoading() {
      if (window.MediaPipeLoaded) {
        console.log('MediaPipe is ready');
        return;
      }
      if (window.MediaPipeError) {
        console.error('MediaPipe loading failed:', window.MediaPipeError);
        return;
      }
      // 아직 로딩 중
      setTimeout(checkMediaPipeLoading, 100);
    }
    checkMediaPipeLoading();
  </script>
  <script src="js/mediapipe_web.js" defer></script>
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>
